import React, { useEffect, useRef, useCallback, useMemo, CSSProperties } from 'react';
import { useFluidGradientSystem } from '@/hooks/useFluidGradient';

interface FluidGradientBackgroundProps {
  children?: React.ReactNode;
  className?: string;
}

/**
 * Componente otimizado que gerencia o sistema de gradientes fluidos
 * Utiliza t√©cnicas de otimiza√ß√£o para reduzir repaints e melhorar performance
 */
const FluidGradientBackground: React.FC<FluidGradientBackgroundProps> = React.memo(({ 
  children, 
  className = '' 
}) => {
  // Usar refs para armazenar valores que n√£o devem causar re-renderiza√ß√µes
  const lastLogRef = useRef<string>('');

  // Inicializar sistema de gradientes
  const { currentSection, getCurrentSectionInfo, setSection } = useFluidGradientSystem();
  console.log('üé® FluidGradientBackground: Hook initialized, currentSection:', currentSection);
  
  // Usar useMemo para valores derivados que n√£o mudam frequentemente
  const sectionInfo = useMemo(() => getCurrentSectionInfo(), [getCurrentSectionInfo]);

  // Debug em desenvolvimento - otimizado para evitar logs desnecess√°rios
  useEffect(() => {
    if (import.meta.env.DEV) {
      const logMessage = `üé® Fluid Gradient: ${sectionInfo.displayName} (${currentSection})`;
      
      // S√≥ loga se a mensagem for diferente da anterior
      if (logMessage !== lastLogRef.current) {
        console.log(logMessage, {
          section: sectionInfo.displayName,
          className: currentSection,
          timestamp: new Date().toISOString()
        });
        lastLogRef.current = logMessage;
      }
    }
  }, [currentSection, sectionInfo]);

  // Usar useMemo para o container dos filhos para evitar re-renderiza√ß√µes desnecess√°rias
  const childrenContainer = useMemo(() => {
    if (!children) return null;
    
    return (
      <div 
        className={`relative z-10 ${className}`}
        // Adiciona atributos para melhor acessibilidade e SEO
        role="main"
        aria-live="polite"
        aria-atomic="true"
      >
        {children}
      </div>
    );
  }, [children, className]);

  return (
    <>
      {/* O container √© criado pelo hook useGradientContainer */}
      {childrenContainer}
    </>
  );
});

// Adicionar displayName para melhor debugging
FluidGradientBackground.displayName = 'FluidGradientBackground';

// Adicionar propriedades est√°ticas para documenta√ß√£o
if (process.env.NODE_ENV === 'development') {
  // Adicionando propriedade para debug apenas em desenvolvimento
  const WhyDidYouRender = {
    logOnDifferentValues: false,
    trackHooks: true
  };
  
  // @ts-ignore - Propriedade para debug
  FluidGradientBackground.whyDidYouRender = WhyDidYouRender;
}

/**
 * Componente indicador visual da se√ß√£o atual (opcional)
 * √ötil para debug ou como indicador de navega√ß√£o
 */
// Componente otimizado para mostrar a se√ß√£o atual (apenas em desenvolvimento)
export const GradientSectionIndicator: React.FC = React.memo(() => {
  const { getCurrentSectionInfo } = useFluidGradientSystem();
  
  // Usar useMemo para evitar rec√°lculos desnecess√°rios
  const sectionInfo = useMemo(() => getCurrentSectionInfo(), [getCurrentSectionInfo]);

  // N√£o renderizar em produ√ß√£o
  if (import.meta.env.PROD) {
    return null;
  }

  return (
    <div 
      className="fixed top-20 right-4 z-50 bg-black/80 text-white px-3 py-2 rounded-lg text-sm font-mono backdrop-blur-sm"
      style={{
        // Otimiza√ß√µes para melhor desempenho
        willChange: 'transform, opacity',
        transform: 'translateZ(0)',
        WebkitTransform: 'translateZ(0)'
      }}
    >
      <div className="text-xs opacity-70">Se√ß√£o Atual:</div>
      <div className="font-semibold">{sectionInfo.displayName}</div>
      <div className="text-xs opacity-50">{sectionInfo.className}</div>
      <div className="mt-1 pt-1 border-t border-white/10 text-2xs opacity-50">
        {new Date().toLocaleTimeString()}
      </div>
    </div>
  );
});

// Adicionar displayName para melhor debugging
GradientSectionIndicator.displayName = 'GradientSectionIndicator';

/**
 * Hook para componentes que precisam reagir √†s mudan√ßas de se√ß√£o
 */
// Hook otimizado para acessar informa√ß√µes da se√ß√£o atual
export const useCurrentSection = () => {
  const { getCurrentSectionInfo } = useFluidGradientSystem();
  
  // Usar useMemo para evitar rec√°lculos desnecess√°rios
  return useMemo(() => getCurrentSectionInfo(), [getCurrentSectionInfo]);
};

// Tipos das se√ß√µes dispon√≠veis
type SectionId = 'perfil' | 'projetos' | 'backlog' | 'contato';

/**
 * Componente wrapper para se√ß√µes que precisam de gradientes espec√≠ficos
 */
interface GradientSectionProps {
  sectionId: SectionId;
  children: React.ReactNode;
  className?: string;
}

// Componente wrapper otimizado para se√ß√µes com gradientes espec√≠ficos
export const GradientSection: React.FC<GradientSectionProps> = React.memo(({
  sectionId,
  children,
  className = ''
}) => {
  return (
    <section 
      id={sectionId}
      className={`relative ${className}`}
      data-gradient-section={sectionId}
    >
      {children}
    </section>
  );
});

/**
 * Componente para transi√ß√µes manuais de gradiente
 * √ötil para navega√ß√£o ou bot√µes que mudam se√ß√£o
 */
interface GradientTriggerProps {
  targetSection: SectionId;
  children: React.ReactNode;
  className?: string;
  onClick?: () => void;
}

// Componente otimizado para disparar mudan√ßas de gradiente
export const GradientTrigger: React.FC<GradientTriggerProps> = React.memo(({
  targetSection,
  children,
  className = '',
  onClick
}) => {
  const { setSection } = useFluidGradientSystem();

  const handleClick = useCallback((e: React.MouseEvent | React.KeyboardEvent) => {
    e.preventDefault();
    setSection(targetSection);
    if (onClick) {
      onClick();
    }
  }, [setSection, targetSection, onClick]);

  const handleKeyDown = useCallback((e: React.KeyboardEvent) => {
    if (e.key === 'Enter' || e.key === ' ') {
      handleClick(e);
    }
  }, [handleClick]);

  return (
    <div 
      className={`cursor-pointer ${className}`}
      onClick={handleClick}
      role="button"
      tabIndex={0}
      onKeyDown={handleKeyDown}
      aria-label={`Ir para a se√ß√£o ${targetSection}`}
    >
      {children}
    </div>
  );
});

export default FluidGradientBackground;
